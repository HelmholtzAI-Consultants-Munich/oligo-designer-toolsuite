name: test n1

on: 
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'pyproject.toml'
      - 'docs/**'
      - 'tutorials/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'pyproject.toml'
      - 'docs/**'
      - 'tutorials/**'
      - '.github/workflows/**'
  workflow_dispatch:
  workflow_call:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.10"] 
        # Add more versions as needed: ["3.10", "3.11", "3.12"]

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      # 1) Setup Miniconda on all platforms
      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-activate-base: false
          activate-environment: test-env
          python-version: ${{ matrix.python-version }}
          # Add channels you need:
          channels: conda-forge, bioconda, defaults
          # Speeds installs
          use-mamba: true

      # 2) Update conda and installed packages
      - name: Update conda
        run: |
          conda update -n base conda --yes
          conda update --all --yes

      # 3) Install conda dependencies
      - name: Install conda dependencies
        run: |
          conda install --yes \
            "blast>=2.15.0" \
            "bedtools>=2.30" \
            "bowtie>=1.3.1" \
            "bowtie2>=2.5"

      # 4) Install pip dependencies
      - name: Install pip dependencies
        run: |
          python --version
          python -m pip install --upgrade pip
          pip install pytest
          # If your package is pip-installable in editable mode:
          pip install -e .

      # 5) Verify environment and run tests
      - name: Check conda environment
        run: conda list

      - name: Test with pytest
        run: pytest --disable-warnings tests/test_oligo_specificity_filter.py
