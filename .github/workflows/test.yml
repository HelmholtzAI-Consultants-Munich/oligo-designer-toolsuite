name: Test with Conda

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.10"] 
        # Add "3.11", "3.12", etc. if desired

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-activate-base: false
          activate-environment: test-env
          # This ensures a new environment with the correct Python is created:
          environment-spec: python=${{ matrix.python-version }}
          use-mamba: true
          # All channels you need:
          channels: conda-forge, bioconda, defaults
          channel-priority: strict

      - name: Show Python version (should be 3.10)
        run: python --version

      - name: Update Conda
        run: mamba update -n base conda --yes

      - name: Install conda dependencies
        run: mamba install --yes \
          "blast>=2.15.0" "bedtools>=2.30" "bowtie>=1.3.1" "bowtie2>=2.5"
        # If any of these packages *force* Python to downgrade,
        # conda will let you know in the solver output.

      - name: Install pip packages
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          pip install -e .

      - name: Verify environment and run tests
        run: |
          echo "Conda environment list:"
          conda env list
          echo "Conda list in test-env:"
          conda list
          echo "Python version in test-env:"
          python --version

      - name: Run pytest
        run: pytest --disable-warnings tests/test_oligo_specificity_filter.py
